<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>CAB Student Market Application</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            /* Theme Colors */
            --bg-dark: #000000;
            --glass-surface: rgba(15, 15, 15, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            
            /* Gradient Accents */
            --gradient-accent: linear-gradient(135deg, #0A84FF, #BF5AF2);
            --gradient-hover: linear-gradient(135deg, #007AFF, #AF52DE);
            --gradient-fire: linear-gradient(135deg, #FF9500, #FF3B30);
            --gradient-success: linear-gradient(135deg, #34C759, #30B0C7);
            --gradient-nolan: linear-gradient(135deg, #FFD60A, #FF9F0A);
            
            /* Modern Rounding */
            --radius-card: 28px;
            --radius-pill: 100px;
            --radius-btn: 16px;
            --blur: 40px;
            
            /* Font */
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* App Specific */
            --max-width-content: 700px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            font-family: var(--font-stack);
            color: var(--text-main); 
            background-color: var(--bg-dark); 
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            min-height: 100vh; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; border: 2px solid var(--bg-dark); }

        #bg-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; 
            background-color: #050505;
            background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.92)), url('https://lh3.googleusercontent.com/d/1Q7do5GuhlylxCvqmlFOtilGxHSZsx2gp');
            background-size: cover;
            background-position: center;
        }

        .app-container { position: relative; max-width: 1280px; margin: 0 auto; padding: 20px 16px; min-height: 100vh; display: flex; flex-direction: column; transition: all 0.4s ease; }
        @media (min-width: 768px) { .app-container { padding: 40px 24px; } }

        /* Welcome Screen Constrained Layout */
        .app-container.welcome-active {
            justify-content: center;
            align-items: center;
            max-width: 420px;
            padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom);
        }

        .view { display: none; opacity: 0; transform: translateY(10px); transition: 0.3s ease; width: 100%; }
        .view.active { display: block; opacity: 1; transform: translateY(0); animation: fadeUp 0.4s ease forwards; }
        
        .hero-banner { width: 100%; max-width: var(--max-width-content); margin: 0 auto 24px; border-radius: var(--radius-card); overflow: hidden; border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0,0,0,0.4); background: #111; line-height: 0; transition: all 0.3s ease; }
        .hero-banner img { width: 100%; height: auto; display: block; }
        
        /* Pro Edition Glass Base */
        .frosted { 
            background: var(--glass-surface);
            backdrop-filter: blur(var(--blur)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--blur)) saturate(150%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            border-radius: var(--radius-card);
            transition: all 0.3s ease; 
        }
        .survey-card { width: 100%; max-width: var(--max-width-content); margin: 0 auto 40px; padding: 24px; }
        @media (min-width: 768px) { .survey-card { padding: 40px; } }

        /* Dynamic Welcome Mode Overlay */
        .survey-card.welcome-mode {
            background: transparent;
            border-color: transparent;
            box-shadow: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            padding: 0;
            margin-bottom: 0;
        }

        .section-header { font-size: 1.1rem; font-weight: 800; color: #ffffff; margin-bottom: 12px; margin-top: 10px; letter-spacing: 0.05em; display: flex; align-items: center; gap: 10px; }
        .section-header::after { content: ""; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }

        .form-group { margin-bottom: 20px; width: 100%; display: flex; flex-direction: column; height: 100%; }
        
        .form-label { display: block; margin-bottom: 12px; color: #ffffff; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; line-height: 1.3; width: 100%; }
        .form-hint { display: block; margin-top: 4px; margin-bottom: 12px; color: var(--text-muted); font-size: 0.8rem; line-height: 1.4; text-transform: none; font-weight: 500; letter-spacing: 0; }

        .required-mark { color: #FF3B30; margin-left: 4px; font-weight: bold; }

        .form-group > .control-item, .form-group > .custom-checkbox { margin-top: auto; }

        /* Pro Edition Inputs */
        input.control-item, select.control-item, textarea.control-item { 
            width: 100%; 
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            color: #fff; padding: 14px 18px; border-radius: var(--radius-btn); font-family: inherit; font-size: 1rem; font-weight: 600;
            outline: none; transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        input.control-item:hover, select.control-item:hover, textarea.control-item:hover { 
            background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.2); 
        }

        .control-item:focus { 
            border-color: #0A84FF; box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15); 
            background: rgba(255,255,255,0.08);
        }

        input[type="file"].control-item { padding: 12px 18px; cursor: pointer; font-weight: 500; }
        input[type="file"]::file-selector-button {
            border: none; background: rgba(255, 255, 255, 0.15); padding: 8px 16px;
            border-radius: 8px; color: #fff; cursor: pointer; margin-right: 15px;
            transition: 0.2s; font-weight: bold;
        }
        input[type="file"]::file-selector-button:hover { background: rgba(255, 255, 255, 0.25); }

        select.control-item { 
            cursor: pointer; padding-right: 36px; appearance: none; -webkit-appearance: none; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); 
            background-repeat: no-repeat; background-position: right 14px center; background-size: 14px; 
        }
        textarea.control-item { min-height: 100px; resize: vertical; }
        
        .custom-checkbox { display: flex; align-items: flex-start; gap: 12px; cursor: pointer; margin-bottom: 8px; font-size: 0.95rem; line-height: 1.5; color: #fff; background: rgba(255,255,255,0.04); padding: 14px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.08); transition: 0.2s; width: 100%; font-weight: 500;}
        .custom-checkbox:hover { background: rgba(255,255,255,0.08); border-color: rgba(255, 255, 255, 0.15); }
        .custom-checkbox input { width: 22px; height: 22px; accent-color: #0A84FF; margin-top: 2px; flex-shrink: 0; cursor: pointer; }

        .conditional-section { display: none; background: rgba(255, 255, 255, 0.03); border-left: 4px solid #0A84FF; padding: 18px; border-radius: 0 12px 12px 0; margin-bottom: 20px; animation: fadeUp 0.3s ease; }

        .btn { padding: 14px 30px; border-radius: var(--radius-btn); font-weight: 700; cursor: pointer; border: none; transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: inline-flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1rem; width: 100%; }
        @media (min-width: 768px) { .btn { width: auto; min-width: 250px; } }

        .btn-primary { background: var(--gradient-accent); color: white; box-shadow: 0 4px 15px rgba(10, 132, 255, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(10, 132, 255, 0.4); }
        .btn-primary:active { transform: translateY(0); }
        .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; min-width: auto; }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }

        .loader { display: none; width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; margin-left: 10px; }
        
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; padding: 16px 24px; border-radius: 100px; background: var(--gradient-success); font-weight: 700; z-index: 3000; display: none; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5); color: #fff; }
        
        footer { margin-top:auto; padding:60px 0 40px; text-align:center; color: var(--text-muted); font-size: 0.85rem; font-weight: 500; letter-spacing: 0.02em; }
        .welcome-active footer { margin-top: 0; padding: 32px 0 10px; }

        .center-btn-wrapper { display: flex; justify-content: center; width: 100%; margin-top: 20px; }
        .success-icon { width: 80px; height: 80px; background: var(--gradient-success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 40px; color: white; box-shadow: 0 10px 20px rgba(52, 199, 89, 0.3); }
        .survey-header-center { text-align: center; margin-bottom: 25px; }
        
        .autofill-indicator { font-size: 0.8rem; color: #34C759; margin-top: 8px; display: none; font-weight: bold; background: rgba(52, 199, 89, 0.1); padding: 8px 12px; border-radius: 8px; display: inline-block; }

        .dynamic-form-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 600px) {
            .dynamic-form-grid { grid-template-columns: 1fr 1fr; gap: 24px 20px; }
            .full-width { grid-column: 1 / -1; }
            .half-width { grid-column: span 1; }
            .dynamic-form-grid .form-group { margin-bottom: 0; } 
        }

        #marketSelectionContainer { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .market-option { background: rgba(255,255,255,0.04); border: 1px solid rgba(255, 255, 255, 0.08); padding: 16px; border-radius: var(--radius-btn); display: flex; align-items: flex-start; gap: 12px; cursor: pointer; transition: 0.2s; }
        .market-option:hover { background: rgba(255,255,255,0.08); }
        .market-option.selected { border-color: #0A84FF; background: rgba(10, 132, 255, 0.1); box-shadow: 0 0 0 1px #0A84FF, inset 0 2px 10px rgba(0, 0, 0, 0.1); }
        .market-option input { width: 18px; height: 18px; accent-color: #0A84FF; margin-top: 2px; flex-shrink: 0; }
        .market-name { font-weight: 800; color: #fff; font-size: 1.05rem; display: block; margin-bottom: 4px; }
        .market-meta { font-size: 0.85rem; color: var(--text-muted); display: block; line-height: 1.5; font-weight: 500;}

        .summary-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 4px; text-align: center; }
        .summary-value { font-size: 1.05rem; color: #fff; display: block; margin-bottom: 24px; font-weight: 600; line-height: 1.4; text-align: center; word-break: break-word;}

        .modal { position: fixed; inset: 0; z-index: 1000; display: none; justify-content: center; align-items: center; padding: 40px; }
        .modal.show { display: flex; }
        .modal-bg { position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); }
        .modal-content { position: relative; width: 100%; max-width: 400px; background: #0a0a0a; border-radius: 32px; padding: 32px; border: 1px solid var(--glass-border); text-align: center; box-shadow: 0 50px 100px rgba(0,0,0,0.8); }
        @media(max-width: 800px) { .modal { padding: 0; } .modal-content { height: 100%; border-radius: 0; justify-content: center;} }

        .builder-q-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 16px; margin-bottom: 12px; position: relative;}
        .builder-q-remove { position: absolute; top: 12px; right: 12px; color: #FF3B30; cursor: pointer; font-weight: bold; background: none; border: none; font-size: 1.2rem; }

        /* WIZARD SPECIFIC STYLES */
        .form-step { display: none; opacity: 0; transform: translateY(10px); transition: 0.3s ease; }
        .form-step.active { display: block; opacity: 1; transform: translateY(0); animation: fadeUp 0.4s ease forwards; }
        
        .wizard-nav { display: flex; justify-content: center; gap: 15px; margin-top: 30px; width: 100%; }
        .wizard-nav .btn { flex: 0 1 auto; width: auto; min-width: 140px; }
        @media (max-width: 380px) { .wizard-nav .btn { min-width: 120px; font-size: 0.95rem; } }
        
        #wizardProgress { text-align: center; margin-bottom: 24px; color: var(--text-muted); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; display: none; }
        .progress-dots { display: flex; justify-content: center; gap: 6px; margin-top: 8px; }
        .progress-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.2); transition: 0.3s; }
        .progress-dot.active { background: #0A84FF; transform: scale(1.2); }

        /* --- EXCLUSIVE WELCOME UI STYLES --- */
        .arena-tag {
            display: inline-flex; align-items: center; padding: 6px 16px; border-radius: 100px; 
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); 
            color: #ffffff; font-size: 0.8rem; font-weight: 900; text-transform: uppercase; 
            letter-spacing: 0.05em; margin-bottom: 30px;
        }
        
        .glass-card-inner {
            background: var(--glass-surface);
            backdrop-filter: blur(var(--blur)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--blur)) saturate(150%);
            border: 1px solid var(--glass-border); 
            border-radius: var(--radius-card); 
            padding: 32px 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            text-align: center; margin: 0 auto; width: 100%; max-width: 420px;
        }

        .big-action-btn {
            background: var(--gradient-accent); color: white;
            border: none; padding: 20px; width: 100%; border-radius: 100px;
            font-weight: 900; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.08em;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
            touch-action: manipulation;
        }
        .big-action-btn:not(:disabled) { animation: pulse-glow 2.5s infinite; }
        .big-action-btn:not(:disabled):hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(10, 132, 255, 0.5); }
        .big-action-btn:active { transform: translateY(0); }
        .big-action-btn:disabled { opacity: 0.25; background: #3a3a3c; box-shadow: none; cursor: not-allowed; animation: none; color: #777; }
        
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); box-shadow: 0 10px 25px -8px rgba(10, 132, 255, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 15px 35px -8px rgba(10, 132, 255, 0.6); }
        }

        .neon-input {
            width: 100%; 
            font-family: inherit;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-btn); padding: 18px;
            color: white; font-size: 1.5rem; font-weight: 800; letter-spacing: 2px;
            outline: none; transition: 0.3s; text-align: center;
        }
        .neon-input::placeholder {
            color: rgba(255, 255, 255, 0.25);
            font-weight: 700; 
            letter-spacing: 1px;
        }
        .neon-input:focus { 
            border-color: #0A84FF; 
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15); 
            background: rgba(255,255,255,0.08);
        }

        /* Status Card Specific UI */
        .status-market-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .status-market-card:hover { background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.2); }
        .status-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .status-name { font-weight: 800; font-size: 1.1rem; color: #fff; line-height: 1.2; }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .status-meta { font-size: 0.8rem; color: var(--text-muted); display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; margin-bottom: 16px; }
        .resend-btn { 
            width: 100%; background: rgba(10, 132, 255, 0.1); border: 1px solid rgba(10, 132, 255, 0.3); 
            color: #0A84FF; padding: 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; 
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .resend-btn:hover { background: rgba(10, 132, 255, 0.2); border-color: #0A84FF; color: #fff; }
        .resend-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Welcome Screen Status Link Styling */
        #step0-status-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            text-decoration: underline;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: 0.2s;
            display: block;
            opacity: 1;
        }
        #step0-status-btn:disabled {
            opacity: 0.3;
            text-decoration: none;
            cursor: not-allowed;
        }
        #step0-status-btn:hover:not(:disabled) {
            color: #fff;
        }
    </style>
</head>
<body>

<div id="bg-container"></div>

<div class="app-container welcome-active" id="mainAppContainer">
    <div class="hero-banner" id="heroBanner" style="display:none;">
        <img id="appHeaderImg" src="https://lh3.googleusercontent.com/d/177iu9igWGiUkD8vdJhZn80PXgLa6hM3c" alt="Student Market">
    </div>

    <!-- APPLICATION FORM VIEW (WIZARD) -->
    <div id="applicationView" class="view active">
        <div class="frosted survey-card welcome-mode" id="mainSurveyCard">
            
            <div id="wizardProgress">
                Step <span id="currentStepNum">1</span> of <span id="totalStepNum">X</span>
                <div class="progress-dots" id="progressDotsContainer"></div>
            </div>

            <form id="multiPageForm" onsubmit="return false;">
                
                <!-- STEP 0: Student ID (Welcome Mode) -->
                <div class="form-step active" id="step-0">
                    <div style="text-align: center;">
                        <div class="arena-tag">
                            <span style="width: 6px; height: 6px; background: #ffffff; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px #ffffff;"></span>
                            STUDENT MARKET 2026
                        </div>
                        <h1 style="margin: 0; font-size: 2.2rem; font-weight: 900; letter-spacing: -0.04em; line-height: 1.1; text-transform: uppercase; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">VENDOR<br>APPLICATION</h1>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 15px; margin-bottom: 35px; font-weight: 500;">Please enter your Student ID to begin the application.</p>
                    </div>
                    
                    <div class="glass-card-inner">
                        <div id="studentIdContainer">
                            <!-- Injected by JS to match UI exactly -->
                        </div>
                        <button id="step0-next-btn" class="big-action-btn" onclick="nextPrev(1)" disabled>Start Application</button>
                        
                        <!-- Status Check Underline Link -->
                        <button id="step0-status-btn" onclick="checkStatus()" disabled>Check Application Status</button>
                    </div>
                </div>

                <!-- STEP 1: Market Selection -->
                <div class="form-step" id="step-1">
                    <div class="survey-header-center">
                        <h3 id="appTitle" style="margin-top:0; font-size: 1.8rem; letter-spacing: -0.02em; line-height: 1.2; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Select Market</h3>
                        <div id="appDesc" style="color: var(--text-muted); margin: 12px auto; line-height: 1.5; font-size: 0.9rem; max-width: 95%;">
                            Loading available markets...
                        </div>
                        <span style="font-size: 0.75rem; color: #FF3B30; font-weight: 700; text-transform: uppercase;">* Indicates required question</span>
                    </div>

                    <!-- Clean Fieldset setup guarantees screen reader accessibility and announces selection properly -->
                    <fieldset class="form-group full-width" style="margin-bottom:15px; border:none; padding:0; margin:0;">
                        <legend class="form-label" id="lbl-market-selection" style="width:100%;">Which Market are you applying for?<span class="required-mark">*</span></legend>
                        <div id="marketSelectionContainer"></div>
                    </fieldset>
                </div>

                <!-- DYNAMIC STEPS (Generated from Config) -->
                <div id="dynamicStepsContainer"></div>

                <!-- WIZARD NAVIGATION -->
                <div class="wizard-nav" id="wizardNavContainer" style="display:none;">
                    <button class="btn btn-ghost" id="prevBtn" onclick="nextPrev(-1)" style="display:none;">Previous</button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextPrev(1)">Next</button>
                    <button class="btn btn-primary" id="submitBtn" onclick="submitApplication()" style="display:none;">
                        <span id="submitBtnText">Submit Application</span>
                        <div class="loader" id="submitLoader"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SUCCESS VIEW -->
    <div id="successView" class="view">
        <div class="frosted survey-card">
            <div style="text-align: center;">
                <div class="success-icon">✓</div>
                <h2 style="margin-top:0; font-size: 2rem; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="successGreeting">Application Received!</h2>
                <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 32px; font-size: 1rem;">
                    Thank you for applying! Your application is now under review. Keep an eye on your email for updates.
                </p>
            </div>

            <div id="summaryContainer" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 32px; margin: 0 auto 32px; max-width: 500px; text-align: center;">
                <div id="summaryHeader" style="font-size: 1.1rem; font-weight: 800; color: #fff; margin-bottom: 24px; text-transform: uppercase; letter-spacing: 0.05em; text-align: center;">
                    Submission Summary
                </div>
                <div id="summaryContent"></div>
            </div>

            <div class="center-btn-wrapper">
                <button class="btn btn-primary" onclick="window.location.reload()">Return to Start</button>
            </div>
        </div>
    </div>

    <!-- ADMIN BUILDER VIEW -->
    <div id="adminView" class="view">
        <div class="frosted survey-card" style="max-width: 900px;">
            <h2 style="margin-top:0; font-size: 1.8rem; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Form Builder Admin</h2>
            <div class="section-header">Global Branding & Text</div>
            <div class="form-group"><label class="form-label">Header Image URL</label><input type="text" id="adminHeaderUrl" class="control-item"></div>
            <div class="form-group"><label class="form-label">Global Form Title</label><input type="text" id="adminEventTitle" class="control-item" placeholder="Leave blank for default"></div>
            <div class="form-group"><label class="form-label">Global Form Description</label><textarea id="adminEventDesc" class="control-item" placeholder="Leave blank for default instructions."></textarea></div>
            
            <div class="section-header" style="margin-top:30px;">
                Form Pages & Questions
                <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal; margin-left: 10px; text-transform: none;">(Section Headers act as page breaks)</span>
            </div>
            
            <div id="adminQuestionsList"></div>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-ghost" style="padding: 12px 24px; font-size: 0.9rem;" onclick="addCustomQuestion('text')">+ Add Question</button>
                <button class="btn btn-ghost" style="padding: 12px 24px; font-size: 0.9rem;" onclick="addCustomQuestion('section_header')">+ Add Header / Page Break</button>
            </div>
            <div class="center-btn-wrapper" style="margin-top: 40px; display:flex; gap: 15px;">
                <button class="btn btn-ghost" onclick="switchView('application')">Exit</button>
                <button class="btn btn-primary" id="adminSaveBtn" onclick="saveAdminConfig()">Save Settings</button>
            </div>
        </div>
    </div>

    <footer>
        © 2026 Canyon Activities Board <br>
        <button class="btn btn-ghost" style="font-size:0.75rem; padding: 6px 12px; margin-top:12px; border:none; opacity: 0.5;" onclick="showAdminGate()">Admin Access</button>
    </footer>
</div>

<!-- Admin Gate Modal -->
<div id="gateModal" class="modal">
    <div class="modal-bg" onclick="hideAdminGate()"></div>
    <div class="modal-content">
        <h3 style="margin-top:0; margin-bottom: 20px; font-size: 1.5rem; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Authorization</h3>
        <input type="password" id="adminPass" class="control-item" placeholder="Enter Password" style="margin-bottom:24px; text-align: center;" onkeyup="if(event.key==='Enter') verifyAdmin()"/>
        <button class="btn btn-primary" onclick="verifyAdmin()" style="width: 100%;">Authorize</button>
    </div>
</div>

<!-- Application Status Modal -->
<div id="statusModal" class="modal">
    <div class="modal-bg" onclick="document.getElementById('statusModal').classList.remove('show')"></div>
    <div class="modal-content" style="max-width: 500px; text-align: left; background: #0a0a0a; border-radius: 32px; padding: 32px; box-shadow: 0 0 100px rgba(0,0,0,0.9); border: 1px solid rgba(255,255,255,0.15);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px;">
            <h3 style="margin:0; font-size: 1.6rem; font-weight: 900; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; letter-spacing: -0.02em;">My Applications</h3>
            <button onclick="document.getElementById('statusModal').classList.remove('show')" style="background:rgba(255,255,255,0.05); border:none; color:#fff; width:36px; height:36px; border-radius:50%; cursor:pointer; line-height: 36px; text-align:center;">&times;</button>
        </div>
        <div id="statusModalContent" style="max-height: 60vh; overflow-y: auto; padding-right: 5px; scrollbar-width: none;"></div>
    </div>
</div>

<div id="toast">Update Successful</div>

<script>
    // Helper to handle Google Drive image links
    function processImageUrl(url) {
        if (!url) return "";
        if (url.includes('drive.google.com')) {
            const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/) || url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return `https://lh3.googleusercontent.com/d/${match[1]}`;
            }
        }
        return url;
    }

    const SUPABASE_URL = 'https://xdfbjusrwbxoxbcocxkp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_ylaFmuuSPD2UcKdF1yKw4g_UPXiRRef';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allEventsData = [];
    let currentTab = 0;
    let isNavigating = false;
    let isAppClosed = false;
    let marketConfigV3 = {}; // Global store for per-market settings

    const defaultQuestions = [
        { id: 'section_personal', type: 'section_header', label: 'Personal Information', width: 'full', isCore: true },
        { id: 'student_id', type: 'number', label: 'Student ID Number', hint: 'Type your ID and tap Next to auto-fill your info!', required: true, width: 'full', isCore: true },
        { id: 'full_name_combined', type: 'text', label: 'First and Last Name', hint: '', required: true, width: 'full', isCore: false },
        { id: 'preferred_email', type: 'email', label: 'Preferred Email', hint: 'Vendor confirmation emails will be sent to your preferred email! Please double check that your email is correct and not misspelled in any way! If it is, you won\'t recieve a confirmation email!', required: true, width: 'full', isCore: true },
        { id: 'gcu_email', type: 'email', label: 'GCU Email', hint: '', required: true, width: 'full', isCore: true },
        { id: 'phone', type: 'tel', label: 'Phone Number', hint: '', required: true, width: 'half', isCore: true },
        { id: 'communication_method', type: 'dropdown', label: 'Preferred Communication Method', hint: '', options: 'Email, Text', required: true, width: 'half', isCore: true },
        { id: 'year', type: 'dropdown', label: 'What year are you at GCU?', hint: '', options: 'Freshman, Sophomore, Junior, Senior', required: true, width: 'half', isCore: true },
        { id: 'availability', type: 'dropdown', label: 'Will you be available for the duration of the market?', hint: '', options: 'Yes, No', required: true, width: 'half', isCore: true },
        
        { id: 'section_vendor', type: 'section_header', label: 'Vendor Details', width: 'full', isCore: true },
        { id: 'food_license', type: 'dropdown', label: 'If you are selling food, do you have your food handlers\' license? This is required to sell food or drinks at our market. If you do not have one, please do not submit this application until you do!', hint: '', options: 'Yes, No, Not applicable', required: true, width: 'full', isCore: true },
        { id: 'past_vendor', type: 'dropdown', label: 'Have you ever worked with CAB at a student market before?', hint: '', options: 'Yes, No', required: true, width: 'full', isCore: true },
        { id: 'description', type: 'textarea', label: 'Vendor/Project Description', hint: '', required: true, width: 'full', isCore: true },
        { id: 'link', type: 'text', label: 'Social Media Handle or Website (Showcasing Your Products)', hint: 'This is not your personal social media account, but rather one that displays the business you\'re running and the items you intend to sell. Note: if your business doesn\'t have a social media account or website, you may include the link to a Google Doc with pictures. Important: make sure the document is public and visible!', required: true, width: 'full', isCore: true },
        
        { id: 'section_logistics', type: 'section_header', label: 'Electricity Vendors', width: 'full', isCore: true },
        { id: 'needs_power', type: 'dropdown', label: 'Do you need to be by an outlet or have access to a power source to run your table?', hint: '', options: 'Yes, No', required: true, width: 'full', isCore: true },
        
        { id: 'section_agreements', type: 'section_header', label: 'Check the boxes to acknowledge', width: 'full', isCore: false },
        { id: 'agree_liability', type: 'checkbox_single', label: 'Liability Acknowledgment', hint: 'I acknowledge that CAB and Grand Canyon University are not responsible and cannot be held liable for the product or quality of the product being sold. As the seller I am liable and bound by any verbal statements/agreement pertaining to the item being sold and am responsible for any causes or results from using its products, services, or any information provided.', required: true, width: 'full', isCore: false },
        { id: 'agree_taxes', type: 'checkbox_single', label: 'Taxes Acknowledgment', hint: 'I acknowledge that as the seller I am fully responsible for claiming income received from this market on applicable taxes. CAB and Grand Canyon University serve as a host to the business owner by offering a free platform for the entrepreneur and thereby do not collect any fees or income from vendors.', required: true, width: 'full', isCore: false },
        { id: 'agree_safety', type: 'checkbox_single', label: 'Safety Acknowledgment', hint: 'I acknowledge that if I as a vendor cannot maintain a safe, friendly and respectful environment, CAB will be obligated to shut down the vendors booth for safety measures.', required: true, width: 'full', isCore: false },
        { id: 'agree_terms', type: 'checkbox_single', label: 'Terms Acknowledgment', hint: 'By applying for student market you acknowledge our terms and hereby consent to our disclaimer and agree to its terms.', required: true, width: 'full', isCore: false },
        { id: 'agree_media', type: 'checkbox_single', label: 'Media Acknowledgment', hint: 'I acknowledge and accept that GCU Student Engagement and CAB Marketing may be utilizing photography and videography at this event that may include myself or my products.', required: true, width: 'full', isCore: false },
        { id: 'additional_comments', type: 'textarea', label: 'Additional Comments, Requests, or Anything You May Need From CAB to Run Your Table Smoothly', hint: 'For any additional questions or concerns, please email lopetownmarket@gmail.com. Thank you for your time!', required: false, width: 'full', isCore: true }
    ];

    let formConfig = { headerUrl: "https://lh3.googleusercontent.com/d/177iu9igWGiUkD8vdJhZn80PXgLa6hM3c", questions: [], forceStatus: 'auto', eventTitle: null, eventDesc: null };

    window.onload = async () => {
        await loadConfig();
        await loadEvents();
        
        document.getElementById('studentIdContainer').addEventListener('input', () => {
            const idInput = document.getElementById('form_student_id');
            const step0Btn = document.getElementById('step0-next-btn');
            const statusBtn = document.getElementById('step0-status-btn');
            
            if (idInput && step0Btn) {
                const isValid = idInput.value.trim().length >= 3;
                if (isAppClosed) {
                    step0Btn.disabled = true;
                } else {
                    step0Btn.disabled = !isValid;
                }
                if (statusBtn) {
                    statusBtn.disabled = !isValid;
                }
            }
        });
    };

    function updateClosedUI(msg) {
        document.getElementById('marketSelectionContainer').innerHTML = '<div style="color:#FF3B30">Applications are currently closed.</div>';
        document.getElementById('nextBtn').disabled = true;
        document.getElementById('appDesc').innerHTML = msg;
        
        const step0Btn = document.getElementById('step0-next-btn');
        if (step0Btn) {
            step0Btn.disabled = true;
            step0Btn.innerText = "APPLICATIONS CLOSED";
        }
        
        const welcomeDesc = document.querySelector('#step-0 p');
        if (welcomeDesc) welcomeDesc.innerText = msg;
    }

    async function loadEvents() {
        try {
            const { data, error } = await _supabase.from('events').select('*').order('created_at', { ascending: false });
            const container = document.getElementById('marketSelectionContainer');
            const lblMarketSelection = document.getElementById('lbl-market-selection');
            
            if (error || !data || data.length === 0) {
                isAppClosed = true;
                updateClosedUI("There are currently no active application windows.");
                return;
            }
            
            allEventsData = data;
            const now = new Date();
            
            let openMarkets = data.filter(e => {
                // Ensure ID checking aligns exactly as string vs string
                const evConfig = marketConfigV3[String(e.id)] || {};
                
                // IGNORE GLOBAL SETTINGS FOR SPECIFIC MARKETS!
                // Read specific status, default ONLY to auto.
                const status = evConfig.forceStatus || 'auto';
                
                if (status === 'closed') return false;
                if (status === 'open') return true;
                
                // 'auto' mode checks the calendar dates
                const isPastOpen = !e.app_open || new Date(e.app_open) <= now;
                const isBeforeClose = !e.app_close || new Date(e.app_close) >= now;
                return isPastOpen && isBeforeClose;
            });

            if (openMarkets.length === 0) {
                isAppClosed = true;
                updateClosedUI("There are currently no active application windows. Please check back later!");
            } else {
                isAppClosed = false;
                document.getElementById('nextBtn').disabled = false;
                
                openMarkets.sort((a, b) => new Date(a.market_date) - new Date(b.market_date));
                
                const welcomeDesc = document.querySelector('#step-0 p');
                if (welcomeDesc) welcomeDesc.innerText = "Please enter your Student ID to begin the application.";
                
                const step0Btn = document.getElementById('step0-next-btn');
                if (step0Btn) step0Btn.innerText = "Start Application";

                if (openMarkets.length > 1) {
                    if (formConfig.eventTitle) document.getElementById('appTitle').innerHTML = formConfig.eventTitle;
                    
                    let descHtml = "";
                    if (formConfig.eventDesc) {
                        descHtml += formConfig.eventDesc + "<br><br>";
                    }
                    descHtml += "<strong>Select one or more markets below to apply:</strong>";
                    
                    document.getElementById('appDesc').innerHTML = descHtml;
                    document.getElementById('appDesc').style.display = 'block';
                    
                    lblMarketSelection.innerHTML = 'Which Markets are you applying for? <span style="text-transform:none; font-weight:normal; font-size:0.85rem; color:var(--text-muted); display:block; margin-top:4px;">Select a market to apply (can apply to multiple)</span><span class="required-mark">*</span>';
                } else {
                    const singleMarket = openMarkets[0];
                    const specificConfig = marketConfigV3[String(singleMarket.id)] || {};
                    
                    // Pull specific title for this market, or fallback
                    document.getElementById('appTitle').innerHTML = specificConfig.title || singleMarket.name || formConfig.eventTitle || "Vendor Application";
                    
                    let descHtml = specificConfig.description || singleMarket.description || formConfig.eventDesc || "";
                    if (descHtml) {
                        document.getElementById('appDesc').innerHTML = descHtml;
                        document.getElementById('appDesc').style.display = 'block';
                    } else {
                        document.getElementById('appDesc').style.display = 'none';
                    }
                    
                    lblMarketSelection.innerHTML = 'Which Market are you applying for? <span style="text-transform:none; font-weight:normal; font-size:0.85rem; color:var(--text-muted); display:block; margin-top:4px;">Select the market below to apply</span><span class="required-mark">*</span>';
                }
                
                container.innerHTML = openMarkets.map(e => {
                    const d = new Date(e.market_date + 'T12:00:00');
                    const formattedDate = d.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
                    const formattedClose = e.app_close ? new Date(e.app_close).toLocaleString() : 'TBD';
                    
                    return `
                    <label class="market-option" id="label_market_${e.id}" for="chk_market_${e.id}">
                        <input type="checkbox" id="chk_market_${e.id}" name="marketChoice" value="${e.id}" onchange="updateMarketSelectionUI()">
                        <div class="market-info-text">
                            <span class="market-name">${e.name}</span>
                            <span class="market-meta">
                                <strong>Date of Market:</strong> ${formattedDate}<br>
                                <strong>Time:</strong> ${e.market_time || '6:30-9:30pm'}<br>
                                <strong>Location:</strong> ${e.location}<br>
                                <span style="color: #FF3B30; font-size: 0.75rem; display: inline-block; margin-top: 4px;">
                                    This application will close on ${formattedClose}
                                </span>
                            </span>
                        </div>
                    </label>`;
                }).join('');
            }
        } catch (e) { console.error(e); }
    }

    function updateMarketSelectionUI() {
        const checkboxes = document.querySelectorAll('input[name="marketChoice"]:checked');
        const availLabel = document.querySelector('[id="lbl-form_availability"]');
        document.querySelectorAll('input[name="marketChoice"]').forEach(cb => {
            const label = document.getElementById(`label_market_${cb.value}`);
            cb.checked ? label.classList.add('selected') : label.classList.remove('selected');
        });
        
        if (availLabel) {
            if (checkboxes.length === 0) {
                availLabel.innerText = 'WILL YOU BE AVAILABLE FOR THE DURATION OF THE MARKET?';
            } else if (checkboxes.length === 1) {
                availLabel.innerText = 'WILL YOU BE AVAILABLE FOR THE FULL DURATION OF THE SELECTED MARKET?';
            } else {
                availLabel.innerText = 'WILL YOU BE AVAILABLE FOR THE FULL DURATION OF ALL SELECTED MARKETS?';
            }
        }
    }

    async function loadConfig() {
        let v8HasText = false;
        try {
            const { data: v8Data } = await _supabase.from('secrets').select('value').eq('name', 'MARKET_FORM_CONFIG_V8').maybeSingle();
            if (v8Data?.value) {
                let p = JSON.parse(v8Data.value);
                formConfig.headerUrl = p.headerUrl || formConfig.headerUrl;
                if (formConfig.headerUrl.includes("imgur.com") || formConfig.headerUrl.includes("export=view")) {
                    formConfig.headerUrl = "https://lh3.googleusercontent.com/d/177iu9igWGiUkD8vdJhZn80PXgLa6hM3c";
                }
                formConfig.questions = p.questions || JSON.parse(JSON.stringify(defaultQuestions));
                if (p.hasOwnProperty('eventTitle')) { formConfig.eventTitle = p.eventTitle; v8HasText = true; }
                if (p.hasOwnProperty('eventDesc')) { formConfig.eventDesc = p.eventDesc; v8HasText = true; }
            } else {
                formConfig.questions = JSON.parse(JSON.stringify(defaultQuestions));
            }

            const { data: v3Data } = await _supabase.from('secrets').select('value').eq('name', 'MARKET_FORM_CONFIG_V3').maybeSingle();
            if (v3Data?.value) {
                try { marketConfigV3 = JSON.parse(v3Data.value); } catch(e){}
                
                // Fallback for older global format
                formConfig.forceStatus = marketConfigV3.forceStatus || 'auto';
                if (!v8HasText) {
                    formConfig.eventTitle = marketConfigV3.title || null;
                    formConfig.eventDesc = marketConfigV3.description || null;
                }
            } else {
                formConfig.forceStatus = 'auto';
            }
            renderPublicForm();
        } catch (e) { 
            formConfig.questions = JSON.parse(JSON.stringify(defaultQuestions)); 
            formConfig.forceStatus = 'auto';
            renderPublicForm(); 
        }
    }

    function generateFieldHtml(q) {
        let inputHtml = '';
        let common = `id="form_${q.id}" class="control-item"`;
        if (q.type === 'textarea') inputHtml = `<textarea ${common}></textarea>`;
        else if (q.type === 'dropdown') {
            const opts = (q.options || '').split(',').map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('');
            let trigger = q.id==='food_license' ? 'onchange="toggleFoodLicense()"' : (q.id==='needs_power' ? 'onchange="togglePowerAgreement()"' : '');
            inputHtml = `<select ${common} ${trigger}><option value="">Select...</option>${opts}</select>`;
        } else if (q.type === 'checkbox_single') {
            inputHtml = `<label class="custom-checkbox"><input type="checkbox" id="form_${q.id}"><span>${q.hint || q.label}</span></label>`;
        } else {
            let placeholderAttr = q.id === 'student_id' ? 'placeholder="e.g. 1234567"' : '';
            inputHtml = `<input type="${q.type}" ${common} ${placeholderAttr} autocomplete="off" />`;
        }
        let hintHtml = q.hint && q.type !== 'checkbox_single' ? `<span class="form-hint">${q.hint}</span>` : '';
        let lbl = `<label class="form-label" id="lbl-form_${q.id}">${q.label}${q.required?'<span class="required-mark">*</span>':''}${hintHtml}</label>`;
        let htmlString = `<div class="form-group ${q.width === 'half' ? 'half-width' : 'full-width'}">${lbl}${inputHtml}</div>`;
        if (q.id === 'food_license') htmlString += `<div id="foodLicenseUploadSection" class="conditional-section full-width"><label class="form-label">Upload AZ food handlers license!<span class="required-mark">*</span></label><input type="hidden" id="formFoodLicenseLinkHidden"><div id="existingLicenseLink"></div><input type="file" id="formFoodLicenseFile" class="control-item" accept="image/*" /></div>`;
        if (q.id === 'needs_power') htmlString += `<div id="powerAgreementSection" class="conditional-section full-width"><label class="form-label" style="color:#FFD60A">ELECTRICITY VENDORS:<span class="required-mark">*</span></label><p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px;line-height:1.4;">Due to high demand, electricity is available on a first-come, first-served basis. We do not provide extension cords. Portable power is STRONGLY encouraged.</p><label class="custom-checkbox"><input type="checkbox" id="powerAgreementCheck"><span>I acknowledge that I have read this statement</span></label></div>`;
        return htmlString;
    }

    function renderPublicForm() {
        document.getElementById('appHeaderImg').src = formConfig.headerUrl;
        const studentIdContainer = document.getElementById('studentIdContainer');
        studentIdContainer.innerHTML = '';
        const dynamicStepsContainer = document.getElementById('dynamicStepsContainer');
        dynamicStepsContainer.innerHTML = '';
        let currentStepDiv = null;
        let currentGrid = null;

        studentIdContainer.innerHTML = `
            <div class="input-group" style="margin-bottom: 24px;">
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.15em; font-weight: 800; margin-bottom: 12px; text-align: center;">Student ID Number</label>
                <input type="tel" id="form_student_id" class="neon-input" placeholder="Type here..." maxlength="8" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
            </div>
        `;

        formConfig.questions.forEach((q) => {
            if (q.id === 'student_id') return;
            if (q.type === 'section_header') {
                if (currentStepDiv) dynamicStepsContainer.appendChild(currentStepDiv);
                currentStepDiv = document.createElement('div');
                currentStepDiv.className = 'form-step';
                currentStepDiv.innerHTML = `<div class="survey-header-center"><h3 style="margin-top:0; font-size: 1.6rem; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.02em;">${q.label}</h3></div>`;
                currentGrid = document.createElement('div');
                currentGrid.className = 'dynamic-form-grid';
                currentStepDiv.appendChild(currentGrid);
                return; 
            }
            if (!currentStepDiv) {
                currentStepDiv = document.createElement('div');
                currentStepDiv.className = 'form-step';
                currentGrid = document.createElement('div');
                currentGrid.className = 'dynamic-form-grid';
                currentStepDiv.appendChild(currentGrid);
            }
            currentGrid.innerHTML += generateFieldHtml(q);
        });
        if (currentStepDiv) dynamicStepsContainer.appendChild(currentStepDiv);
        currentTab = 0;
        showTab(currentTab);
    }

    function showTab(n) {
        let x = document.getElementsByClassName("form-step");
        if(x.length === 0) return;
        for(let i = 0; i < x.length; i++) {
            x[i].style.display = "none";
            x[i].classList.remove('active');
        }
        x[n].style.display = "block";
        setTimeout(() => x[n].classList.add('active'), 10);
        const appContainer = document.getElementById('mainAppContainer');
        const heroBanner = document.getElementById('heroBanner');
        const mainCard = document.getElementById('mainSurveyCard');
        const wizardNav = document.getElementById('wizardNavContainer');
        const progressEl = document.getElementById('wizardProgress');
        if (n === 0) {
            appContainer.classList.add('welcome-active');
            heroBanner.style.display = 'none';
            wizardNav.style.display = 'none';
            progressEl.style.display = 'none';
            mainCard.classList.add('welcome-mode');
        } else {
            appContainer.classList.remove('welcome-active');
            heroBanner.style.display = 'block';
            wizardNav.style.display = 'flex';
            mainCard.classList.remove('welcome-mode');
            if (x.length > 1) {
                progressEl.style.display = 'block';
                document.getElementById('currentStepNum').innerText = (n + 1);
                document.getElementById('totalStepNum').innerText = x.length;
                let dotsHtml = '';
                for(let i = 0; i < x.length; i++) dotsHtml += `<div class="progress-dot ${i === n ? 'active' : ''}"></div>`;
                document.getElementById('progressDotsContainer').innerHTML = dotsHtml;
            }
        }
        if (n === (x.length - 1)) {
            document.getElementById("nextBtn").style.display = "none";
            document.getElementById("submitBtn").style.display = "inline-flex";
        } else {
            document.getElementById("nextBtn").style.display = "inline-flex";
            document.getElementById("submitBtn").style.display = "none";
        }
        if (n > 0) document.getElementById("prevBtn").style.display = "inline-flex";
    }

    async function nextPrev(n) {
        if (isNavigating) return;
        isNavigating = true;
        let x = document.getElementsByClassName("form-step");
        if (n === 1 && !validateForm(currentTab)) {
            isNavigating = false;
            return;
        }
        if (currentTab === 0 && n === 1) {
            let step0Btn = document.getElementById('step0-next-btn');
            let origText = step0Btn.innerHTML;
            step0Btn.innerHTML = 'Verifying...';
            await checkExistingVendor();
            step0Btn.innerHTML = origText;
        }
        x[currentTab].style.display = "none";
        x[currentTab].classList.remove('active');
        currentTab = currentTab + n;
        showTab(currentTab);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        isNavigating = false;
    }

    function validateForm(tabIndex) {
        let x = document.getElementsByClassName("form-step")[tabIndex];
        if (x.id === 'step-1') {
            const selected = document.querySelectorAll('input[name="marketChoice"]:checked');
            if (selected.length === 0) {
                showToast("Please select at least one market to apply to.", true);
                return false;
            }
            return true;
        }
        let inputs = x.querySelectorAll('input, select, textarea');
        for (let i = 0; i < inputs.length; i++) {
            let input = inputs[i];
            if (input.closest('.conditional-section') && input.closest('.conditional-section').style.display === 'none') continue;
            let idMatch = input.id.match(/^form_(.+)$/);
            if (idMatch) {
                let fieldId = idMatch[1];
                let q = formConfig.questions.find(q => q.id === fieldId);
                if (q && q.required) {
                    if (q.type === 'checkbox_single') {
                        if (!input.checked) { showToast(`Please agree to: ${q.label}`, true); return false; }
                    } else if (input.value.trim() === "") { showToast(`Please answer: ${q.label}`, true); input.focus(); return false; }
                }
            }
            if (input.id === 'formFoodLicenseFile') {
                 const needsLicense = document.getElementById('form_food_license')?.value === 'Yes';
                 const hasExisting = document.getElementById('formFoodLicenseLinkHidden')?.value;
                 if (needsLicense && !hasExisting && !input.files[0]) { showToast("Please upload your food handlers license.", true); return false; }
            }
            if (input.id === 'powerAgreementCheck') {
                 const needsPower = document.getElementById('form_needs_power')?.value === 'Yes';
                 if (needsPower && !input.checked) { showToast("Please acknowledge the power statement.", true); return false; }
            }
        }
        return true;
    }

    function generateSummary(selectedIds, payload) {
        const container = document.getElementById('summaryContent');
        if (!container) return;

        const marketNames = selectedIds.map(id => {
            const mkt = allEventsData.find(e => String(e.id) === String(id));
            return mkt ? mkt.name : 'Selected Market';
        });

        const marketLabelsHtml = marketNames.map(m => `
            <div style="background: rgba(10, 132, 255, 0.15); border: 1px solid rgba(10, 132, 255, 0.3); color: #fff; padding: 10px 18px; border-radius: 12px; font-weight: 700; font-size: 1rem; display: inline-block; margin: 6px; box-shadow: 0 4px 15px rgba(10,132,255,0.1);">
                ${m}
            </div>
        `).join('');

        container.innerHTML = `
            <div style="margin-bottom: 30px;">
                <span style="color: var(--text-muted); font-size: 0.85rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.08em; display: block; margin-bottom: 16px;">Markets Applied For</span>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;">
                    ${marketLabelsHtml}
                </div>
            </div>
            <div style="margin-bottom: 24px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                <span style="display:block; margin-bottom:6px; color: var(--text-muted); font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">Applicant</span>
                <span style="display:block; font-size: 1.3rem; font-weight: 800; color: #fff;">${payload.first_name} ${payload.last_name}</span>
            </div>
            <div style="background: rgba(52, 199, 89, 0.1); padding: 20px; border-radius: 20px; border: 1px solid rgba(52, 199, 89, 0.2);">
                <span style="display:block; margin-bottom:6px; color: var(--text-muted); font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">Application Status</span>
                <span style="color: #34C759; margin-bottom:0; font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="width: 10px; height: 10px; background: #34C759; border-radius: 50%; box-shadow: 0 0 10px #34C759;"></span> Received & In Review
                </span>
            </div>
        `;
    }

    async function checkStatus() {
        const id = document.getElementById('form_student_id').value.trim();
        if (id.length < 3) return;
        const btn = document.getElementById('step0-status-btn');
        const origText = btn.innerText;
        btn.innerText = "Verifying ID...";
        btn.disabled = true;

        try {
            if (allEventsData.length === 0) {
                const { data } = await _supabase.from('events').select('*');
                if (data) allEventsData = data;
            }
            const now = new Date();
            now.setHours(0,0,0,0);
            const upcomingEvents = allEventsData.filter(e => new Date(e.market_date + 'T00:00:00') >= now);
            const { data: apps } = await _supabase.from('vendors').select('*').eq('student_id', id).order('created_at', { ascending: false });

            if (!apps || apps.length === 0) {
                showToast("No records found for this ID.", true);
                return;
            }

            const matchedApps = apps.map(app => {
                const event = upcomingEvents.find(ev => ev.id === app.event_id);
                if (!event) return null;
                let displayStatus = 'In Review';
                
                // Fixed: Check for ANY sent email type instead of just 'Yes'
                if (app.email_sent && app.email_sent !== 'No') {
                    if (app.status === 'Approved' || app.status === 'Checked In') displayStatus = 'Approved';
                    else if (app.status === 'Denied') displayStatus = 'Denied';
                }
                return { ...app, eventName: event.name, eventDate: event.market_date, eventLoc: event.location, eventTime: event.market_time, displayStatus };
            }).filter(Boolean);

            if (matchedApps.length === 0) {
                showToast("No upcoming applications found.", true);
                return;
            }

            let html = '';
            matchedApps.forEach(a => {
                const d = new Date(a.eventDate + 'T12:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
                let color = '#FF9500'; let icon = '⏳';
                if (a.displayStatus === 'Approved') { color = '#34C759'; icon = '✅'; }
                if (a.displayStatus === 'Denied') { color = '#FF3B30'; icon = '❌'; }

                // Fixed: Ensure the resend button appears for all sent types
                const canResend = (a.email_sent && a.email_sent !== 'No');

                html += `
                    <div class="status-market-card">
                        <div class="status-header">
                            <div class="status-name">${a.eventName}</div>
                            <div class="status-badge" style="background: ${color}22; border: 1px solid ${color}55; color: ${color};">
                                ${icon} ${a.displayStatus}
                            </div>
                        </div>
                        <div class="status-meta">
                            <span style="opacity: 0.5;">🗓️ Date</span> <span>${d}</span>
                            <span style="opacity: 0.5;">⏰ Time</span> <span>${a.eventTime || 'TBA'}</span>
                            <span style="opacity: 0.5;">📍 Place</span> <span>${a.eventLoc || 'TBA'}</span>
                        </div>
                        ${canResend ? `
                            <button id="resend-${a.id}" class="resend-btn" onclick="resendStatusEmail('${a.id}', '${a.event_id}')">
                                📩 Resend Status Email
                            </button>
                        ` : `
                            <div style="font-size: 0.75rem; color: #FF9500; font-weight: 700; text-align: center; padding: 10px; background: rgba(255,149,0,0.05); border-radius: 12px;">
                                Application is still being processed.
                            </div>
                        `}
                    </div>
                `;
            });
            document.getElementById('statusModalContent').innerHTML = html;
            document.getElementById('statusModal').classList.add('show');
        } catch (e) { console.error(e); showToast("System error", true); }
        finally { btn.innerText = origText; btn.disabled = false; }
    }

    async function resendStatusEmail(appId, eventId) {
        const btn = document.getElementById(`resend-${appId}`);
        const origHtml = btn.innerHTML;
        btn.innerHTML = 'Sending Email...';
        btn.disabled = true;

        try {
            const { data: secrets } = await _supabase.from('secrets').select('*');
            const apiKey = secrets.find(s => s.name === 'BREVO_API_KEY')?.value;
            if(!apiKey) throw new Error("API Key missing");

            const { data: vendor } = await _supabase.from('vendors').select('*').eq('id', appId).single();
            const { data: event } = await _supabase.from('events').select('*').eq('id', eventId).single();

            let subj = '', body = '';
            const isApproved = vendor.status === 'Approved' || vendor.status === 'Checked In';
            
            if (isApproved) {
                subj = event.template_approved_subject; body = event.template_approved_body;
                if (vendor.needs_power === 'Yes') {
                    subj = event.template_power_subject || subj; body = event.template_power_body || body;
                }
            } else {
                subj = event.template_denied_subject; body = event.template_denied_body;
            }

            const bannerUrl = processImageUrl(event.banner_url || "");
            const headingText = event.heading_text || "Market Status Update";
            const statusColor = isApproved ? '#34C759' : '#FF3B30';
            const statusBadgeText = isApproved ? 'APPROVED' : 'STATUS UPDATE';

            const htmlBodyText = body.replace(/\{\{FIRST\}\}/g, vendor.first_name)
                                     .replace(/\{\{EVENT\}\}/g, event.name)
                                     .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                                     .replace(/\n/g, '<br>');

            const parsedSubj = subj.replace(/\{\{FIRST\}\}/g, vendor.first_name).replace(/\{\{EVENT\}\}/g, event.name);

            const qrHtml = isApproved ? `
                <tr><td style="padding: 0 15px; background-color: #ffffff;"><div style="border-top: 2px dashed #e5e7eb; width: 100%; height: 1px;"></div></td></tr>
                <tr><td align="center" style="padding: 40px 30px; background-color: #ffffff;">
                    <table border="0" cellspacing="0" cellpadding="0" width="100%">
                        <tr><td align="center" style="background: #ffffff; padding: 25px; border-radius: 16px; border: 2px solid #eeeeee;">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${vendor.id}&format=png&bgcolor=FFFFFF&color=000000&margin=10" alt="Ticket" width="250" style="display: block; margin: 0 auto; max-width: 100%; border: 0;">
                        </td></tr>
                    </table>
                    <p style="margin: 25px 0 0 0; font-size: 14px; color: #1a1a1a; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; font-family: sans-serif;">SCAN AT CHECK-IN</p>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #888888; font-family: monospace;">ID: #${vendor.id.substring(0,8).toUpperCase()}</p>
                </td></tr>` : '';

            const fullHtmlContent = `
            <!DOCTYPE html>
            <html lang="en">
            <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>
            <body style="margin: 0; padding: 0; background-color: #f3f4f6; font-family: 'Segoe UI', Arial, sans-serif;">
                <table border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #f3f4f6; padding: 20px;">
                    <tr><td align="center">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px; background-color: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                            ${bannerUrl ? `<tr><td align="center" style="padding: 0;"><img src="${bannerUrl}" width="600" style="display: block; width: 100%; max-width: 100%; height: auto; border: 0;"></td></tr>` : ""}
                            <tr><td align="center" style="background-color: #ffffff; padding: 40px 30px 20px 30px;">
                                <h1 style="margin: 0; font-size: 24px; font-weight: 800; color: #111; text-transform: uppercase;">${headingText}</h1>
                                <p style="margin: 12px 0 0 0; font-size: 12px; font-weight: 700; color: #fff; background-color: ${statusColor}; display: inline-block; padding: 6px 16px; text-transform: uppercase; letter-spacing: 1px; border-radius: 20px;">${statusBadgeText}</p>
                            </td></tr>
                            <tr><td style="padding: 10px 40px 40px 40px; background-color: #ffffff; font-size: 16px; color: #333; line-height: 1.6;">${htmlBodyText}</td></tr>
                            ${qrHtml}
                            <tr><td align="center" style="background-color: #f9fafb; padding: 20px; border-top: 1px solid #eaeaea;">
                                <p style="margin: 0; font-size: 12px; font-weight: 600; color: #aaa; text-transform: uppercase;">&copy; Canyon Activities Board</p>
                            </td></tr>
                        </table>
                    </td></tr>
                </table>
            </body></html>`;

            const response = await fetch("https://api.brevo.com/v3/smtp/email", {
                method: 'POST',
                headers: { 'accept': 'application/json', 'api-key': apiKey, 'content-type': 'application/json' },
                body: JSON.stringify({
                    sender: { name: 'Canyon Activities Board', email: 'studentmarkets@cabgcu.com' },
                    to: [{ email: vendor.preferred_email, name: `${vendor.first_name} ${vendor.last_name}` }],
                    subject: parsedSubj, 
                    htmlContent: fullHtmlContent
                })
            });

            if(!response.ok) throw new Error("Email service failed");
            showToast("✨ Email resent successfully!");
        } catch(e) { console.error(e); showToast("Resend failed", true); }
        finally { btn.innerHTML = origHtml; btn.disabled = false; }
    }

    function showAdminGate() { document.getElementById('gateModal').classList.add('show'); }
    function hideAdminGate() { document.getElementById('gateModal').classList.remove('show'); }
    function verifyAdmin() { if (document.getElementById('adminPass').value === 'Vendor49!') { hideAdminGate(); renderAdminPanel(); switchView('admin'); } else { showToast('Invalid', true); } }
    function renderAdminPanel() { 
        document.getElementById('adminHeaderUrl').value = formConfig.headerUrl || ''; 
        document.getElementById('adminEventTitle').value = formConfig.eventTitle || '';
        document.getElementById('adminEventDesc').value = formConfig.eventDesc || '';
        renderAdminQuestionsList(); 
    }
    function renderAdminQuestionsList() {
        const list = document.getElementById('adminQuestionsList');
        list.innerHTML = formConfig.questions.map((q, i) => `
            <div class="builder-q-card">
                <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                    <div style="display:flex;gap:5px">
                        <button class="btn btn-ghost" style="padding:4px 8px; min-width:auto; font-size:12px;" onclick="moveQ(${i},-1)">↑</button>
                        <button class="btn btn-ghost" style="padding:4px 8px; min-width:auto; font-size:12px;" onclick="moveQ(${i},1)">↓</button>
                    </div>
                    <button class="builder-q-remove" onclick="deleteQ(${i})">&times;</button>
                </div>
                <label style="font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:4px;">Type</label>
                <select class="control-item" style="margin-bottom:12px;" onchange="updateQ(${i}, 'type', this.value)">
                    <option value="text" ${q.type==='text'?'selected':''}>Short Text</option>
                    <option value="textarea" ${q.type==='textarea'?'selected':''}>Paragraph</option>
                    <option value="email" ${q.type==='email'?'selected':''}>Email</option>
                    <option value="tel" ${q.type==='tel'?'selected':''}>Phone</option>
                    <option value="number" ${q.type==='number'?'selected':''}>Number</option>
                    <option value="dropdown" ${q.type==='dropdown'?'selected':''}>Dropdown</option>
                    <option value="checkbox_single" ${q.type==='checkbox_single'?'selected':''}>Agreement</option>
                    <option value="section_header" ${q.type==='section_header'?'selected':''}>Header</option>
                </select>
                <label style="font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:4px;">Label</label>
                <input type="text" class="control-item" style="margin-bottom:12px;" value="${q.label}" onchange="updateQ(${i},'label',this.value)">
                ${q.type !== 'section_header' ? `
                    <label style="font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:4px;">Hint</label>
                    <input type="text" class="control-item" style="margin-bottom:12px;" value="${q.hint || ''}" onchange="updateQ(${i},'hint',this.value)">
                ` : ''}
            </div>`).join('');
    }
    function addCustomQuestion(t) { formConfig.questions.push({ id: 'q_'+Date.now(), type: t==='section_header'?'section_header':'text', label: 'New Item', width: 'full', required: false, isCore: false }); renderAdminQuestionsList(); }
    function deleteQ(i) { formConfig.questions.splice(i, 1); renderAdminQuestionsList(); }
    function moveQ(i, d) { let n=i+d; if(n<0||n>=formConfig.questions.length)return; [formConfig.questions[i],formConfig.questions[n]]=[formConfig.questions[n],formConfig.questions[i]]; renderAdminQuestionsList(); }
    function updateQ(i,k,v) { formConfig.questions[i][k]=v; if (k === 'type') renderAdminQuestionsList(); }
    async function saveAdminConfig() { 
        formConfig.headerUrl = document.getElementById('adminHeaderUrl').value;
        formConfig.eventTitle = document.getElementById('adminEventTitle').value;
        formConfig.eventDesc = document.getElementById('adminEventDesc').value;
        try { 
            await _supabase.from('secrets').upsert([{ name: 'MARKET_FORM_CONFIG_V8', value: JSON.stringify(formConfig) }], { onConflict: 'name' }); 
            showToast("Saved"); 
            setTimeout(() => window.location.reload(), 1000); 
        } catch(e){ 
            showToast("Error",true); 
        } 
    }

    async function checkExistingVendor() {
        const id = document.getElementById('form_student_id').value.trim();
        if(id.length < 4) return false;
        try {
            const { data } = await _supabase.from('vendors').select('*').eq('student_id', id).order('created_at', { ascending: false }).limit(1);
            if(data && data[0]) {
                const v = data[0];
                formConfig.questions.forEach(q => { 
                    const el = document.getElementById('form_'+q.id); 
                    if(el && q.id !== 'additional_comments' && q.id !== 'student_id') {
                        if (q.id === 'full_name_combined') el.value = (v.first_name + ' ' + v.last_name).trim();
                        else if (v[q.id]) el.value = v[q.id];
                    }
                });
                if (v.food_license_link) {
                    document.getElementById('formFoodLicenseLinkHidden').value = v.food_license_link;
                    document.getElementById('existingLicenseLink').innerHTML = `<div style="color:#34C759; font-size:0.85rem; margin:10px 0; font-weight:800; background:rgba(52,199,89,0.1); padding:10px; border-radius:10px; border:1px solid rgba(52,199,89,0.2);">✅ Existing license found on file.</div>`;
                }
                toggleFoodLicense(); togglePowerAgreement();
                showToast("✨ Profile auto-filled!", false);
                return true;
            }
        } catch(e) {}
        return false;
    }

    async function submitApplication() {
        if(!validateForm(currentTab)) return;
        const selectedIds = Array.from(document.querySelectorAll('input[name="marketChoice"]:checked')).map(cb => cb.value);
        const btn = document.getElementById('submitBtn');
        const basePayload = { status: 'Pending', email_sent: 'No', first_name: '', last_name: '' };
        
        let agreements = []; // Track all checked agreements

        for(let q of formConfig.questions) {
            if(q.type==='section_header') continue;
            const el = document.getElementById('form_'+q.id);
            if(!el) continue;
            const val = q.type==='checkbox_single' ? (el.checked?'Yes':'No') : el.value.trim();
            if(q.id === 'full_name_combined') {
                const parts = val.split(' ');
                basePayload.first_name = parts[0] || val;
                basePayload.last_name = parts.slice(1).join(' ') || '.'; 
            }
            
            if(q.isCore) {
                basePayload[q.id] = val; 
            } else if (q.type === 'checkbox_single' && el.checked) {
                // Collect the labels of any checked agreement boxes
                agreements.push(q.label);
            }
        }
        
        // Also capture the dynamically rendered electricity agreement check!
        if (document.getElementById('form_needs_power')?.value === 'Yes' && document.getElementById('powerAgreementCheck')?.checked) {
            agreements.push("Electricity Requirements Acknowledgment");
        }
        
        // Save the tracked array as a clean JSON string to the database
        basePayload.agreements_checked = JSON.stringify(agreements);

        if (basePayload.food_license==='Yes') {
             const file = document.getElementById('formFoodLicenseFile').files[0];
             const existing = document.getElementById('formFoodLicenseLinkHidden').value;
             if(file) {
                 const path = `license_${Date.now()}.jpg`;
                 await _supabase.storage.from('licenses').upload(path, await compressImage(file));
                 basePayload.food_license_link = _supabase.storage.from('licenses').getPublicUrl(path).data.publicUrl;
             } else basePayload.food_license_link = existing;
        }
        basePayload.additional_comments = document.getElementById('form_additional_comments')?.value.trim() || '';
        btn.disabled = true;
        try {
            const inserts = selectedIds.map(id => ({ ...basePayload, event_id: id }));
            const { error } = await _supabase.from('vendors').insert(inserts);
            if(error) throw error;
            
            // Generate visual summary mapping to all selected markets
            generateSummary(selectedIds, basePayload);

            switchView('success');
            if (typeof confetti === 'function') confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#0A84FF', '#BF5AF2', '#ffffff'] });
        } catch(e) { showToast("Submission failed", true); }
        finally { btn.disabled = false; }
    }

    function toggleFoodLicense() { let s = document.getElementById('foodLicenseUploadSection'); if(s) s.style.display = document.getElementById('form_food_license').value==='Yes'?'block':'none'; }
    function togglePowerAgreement() { let s = document.getElementById('powerAgreementSection'); if(s) s.style.display = document.getElementById('form_needs_power').value==='Yes'?'block':'none'; }
    function switchView(v) { document.querySelectorAll('.view').forEach(e => e.classList.remove('active')); document.getElementById(v + 'View').classList.add('active'); window.scrollTo(0,0); }
    function showToast(m, e) { const t = document.getElementById('toast'); t.innerText = m; t.style.background = e ? 'var(--gradient-fire)' : 'var(--gradient-success)'; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 4000); }
    async function compressImage(file) {
        return new Promise(res => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if(w > 1000) { h = Math.round((h * 1000) / w); w = 1000; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(blob => res(new File([blob], file.name, { type: 'image/jpeg' })), 'image/jpeg', 0.6);
                };
            };
        });
    }
</script>
</body>
</html>
